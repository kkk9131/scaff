# 階層管理（フロア）要件定義（Phase 2）

本ドキュメントは「1階/2階…」といった階層（フロア）管理の要件を定義する。将来の立面・3D拡張を見据え、高さ座標（Z）を保持する。

## 用語定義
- 床レベルZ: 各階の床上端の絶対高さ(mm)。Z=0 を基準（既定: 1F床=0mm）。+Zは上向き。
- 階高: その階の床上端から天井（または壁頂）までの高さ(mm)。

## 目的/スコープ
- 平面座標はそのまま複製し、1F/2F…の階層で独立編集できるようにする。
- 将来の立面/3Dでは floors[].elevationMm と floors[].heightMm をそのまま使用する。

## 複製ルール
- 複製対象: 壁のみ（寸法・軒の出・ガイド等は複製しない）。
- 独立性: 完全コピー（階間リンクなし）。以後は各階で独立編集。

## 表示/編集要件
- アクティブ階のみ編集可。他階はヒットテスト不可（ロック扱い）、半透明表示。
- 複数階を同時表示可能。描画順は下階→上階（下から重ねる）。
- 階ごとに壁・軒の出の線色を変更可能（パレットの自動割当＋手動上書きを想定）。

## UI（階層セクション）
- 階リスト（1F/2F…）で以下を操作:
  - 追加 / 削除 / 複製 / リネーム
  - 高さ入力: 各行で 床レベルZ(mm)・階高(mm) を直接編集
  - 表示ON/OFF（目）・ロック（鍵）
- ショートカット: 階切替（PgUp/PgDn など）。
- Fit/ズームは階に依存せず全体に適用。

## ズーム/スナップ整合
- px/mm は全体スケールに追従。階の可視/編集状態に依らずズームは共通。
- スナップはアクティブ階の編集時のみ適用。

## データモデル（保存スキーマ案）
```
{
  floors: [
    {
      id: string,
      name: string,           // 例: "1F", "2F"
      elevationMm: number,    // 床レベルZ
      heightMm: number,       // 階高
      color?: {
        walls?: string,
        eaves?: string,
      },
      // 2Dと3D押し出しで利用する平面フットプリント
      walls: {
        outer: { x: number, y: number }[],   // 反時計回り（画面座標系）
        holes?: { x: number, y: number }[][] // 任意の穴。時計回り
      },
      // 軒の出（2D/3Dで共用）
      eaves?: {
        enabled: boolean,
        amountMm: number,
        perEdge?: { [edgeIndex: number]: number }
      },
    }
  ]
}
```
- レイヤーの可視/ロック状態は「保存なし」（セッション/UI状態）。必要に応じ将来保存に昇格。

## 3D準備（押し出しの前提）
- 単位/軸: mm、+Z が上。既定: 1Fの床Z=0mm。
- 階の立体: `walls` を `zBottom = elevationMm` から `zTop = elevationMm + heightMm` までZ方向に押し出す。
  - メッシュ安定化のため、外周=反時計回り、穴=時計回りを厳守。
  - 本フェーズでは壁の厚みは持たせず、プリズム（中空）として扱う。
- 3Dでの軒の出: `eaves.enabled` のとき、階の上端に薄い水平プレートを生成する。
  - 平面形状=外周の外側オフセット（`amountMm`/`perEdge`）。2D仕様と同じく自己交差はUnionで解消。
  - 垂直方向の範囲は `[zTop - eavesThicknessMm, zTop]`。
  - `eavesThicknessMm` 既定=50mm（後から設定可能）。色は `color.eaves` を使用。
- 屋根形状（切妻・寄棟など）は本フェーズの対象外（後続フェーズで追加）。

## 受け入れ基準（3D対応の補足）
- `walls` を外周+穴の構造で保存し、向きを規定通りに保持できる。
- `eaves` から階上端の薄板形状を導出できる（有効時）。

## 既定値/上限（提案）
- 新規階の既定値:
  - name: 自動採番（nF）
  - elevationMm: 直下階の elevationMm + heightMm
  - heightMm: 直下階と同じ（初期 2800mm など）
  - color: パレットからローテーション
- 最大階数: 明示制限なし（運用目安: 20 程度）

## 受け入れ基準
- 階の追加/削除/複製/リネーム・高さ編集が即時反映される。
- アクティブ階のみ編集可、他階は半透明/ロックでヒットしない。
- 階ごと線色が反映され、複数階同時表示で視認性が保たれる。
- 保存/読込で floors スキーマが再現される（レイヤー可視/ロックはセッションのみ）。
