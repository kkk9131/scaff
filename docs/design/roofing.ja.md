# 屋根生成ロジック 仕様（フェーズ3）

本ドキュメントは「平面→立面→3D」を前提に、階ごとに複数屋根・下屋を扱うための屋根生成ロジックの仕様をまとめる。実装は未着手であり、要件確定のための設計メモである。

## 1. スコープ/前提
- 階単位で屋根を複数持てる（同じ平面位置に別階の屋根が重なる場合あり）。
- 形状タイプ: フラット / 切妻 / 寄棟 / 片流れ。
- 平面図で eaves（軒の出）を設定済みとし、屋根外形は eaves を反映した外周で描画する。
- 勾配入力: 寸勾配（X寸）。範囲 0〜15 寸、刻み 0.5 寸。
  - 0 寸はフラットのみ許容。他タイプで 0 指定時はフラットを提案（警告）。
- 描画エンジン/線画は既存と統一（Canvas 本体＋SVGオーバーレイ）。
- 屋根線のスタイル: 「階の色」かつ「点線」。棟線・谷線・補助線も点線（細線）。
- Z順: 壁 < 屋根線 < 寸法線 < ラベル/ハンドル。px/mm のスケーリングは既存に追従。

## 2. データモデル（保存スキーマ案）
- `floors[i].roofUnits: RoofUnit[]`
- RoofUnit 共通フィールド案:
  - `id: string`
  - `type: "flat" | "gable" | "hip" | "mono"`
  - `mode?: "byPitch" | "byApex"`（寄棟は byApex 既定、切妻/片流れは byPitch 既定）
  - `pitchSun?: number`（0..15、step 0.5。表示は「X寸（θ°）」併記可）
  - `ridgeAxis?: "NS" | "EW"`（gable/hip 用）
  - `gableEdges?: number[]`（切妻にする辺の配列。複数可。全辺指定も許容＝棟なし扱い）
  - `monoDownhill?: "N" | "S" | "E" | "W"`（片流れの流れ方向＝低い側）
  - `apexHeightMm?: number`（byApex 用。軒高に対する加算ではなく絶対 Z 指定も可。実装時に統一）
  - `footprint: { kind: "outer" | "polygon", polygon?: {x:number,y:number}[] }`
  - `eavesOverride?: { enabled?: boolean, amountMm?: number, perEdge?: { [edgeIndex:number]: number } }`
  - `computed?: { outline: {x:number,y:number}[], ridges: Line[], valleys: Line[] }`（キャッシュ）

補足: 下屋は `footprint.kind = "polygon"` で部分領域を保持。初期は自動抽出（上階の陰を除外した露出領域）を提案し、ユーザー上書きを許容。

## 3. 共通幾何/描画ルール
- 外形生成: `footprint` を eaves 分だけ外側へオフセット → 自己交差は Union で一体化 → 反時計回りで保持。
- 平面図の方針（重要）: 屋根外形は「軒の出ライン」と同一として扱う。別個に屋根用の輪郭線は描かない（重複防止）。
  - したがって平面では、既存の軒ライン（階色＋点線）がそのまま屋根外形となり、屋根はラベルのみを追加表示する。
  - eaves=0/無効の場合は、屋根ラベルのみ（必要なら将来オプションで壁外形に沿った補助線を検討）。
- 多層の重なり: 平面は下階→上階の順で重ね描き。アクティブ階のみ編集可、他階は半透明/ロック。
- 上階の陰除外: 既定 ON。必要時 OFF にして重なりを許容（屋根単位のトグル）。
- ラベル: 平面重心付近に配置。ドラッグで微調整可能。既存ラベルの衝突回避ロジックに準拠。

## 4. タイプ別仕様
### 4.1 フラット（flat）
- 入力: `parapetHeightMm`（既定 150mm、10mm 刻み推奨）。
- 平面: eaves 反映外形。棟/谷なし（`ridges=[], valleys=[]`）。
- 立面: 軒高=`elevationMm + heightMm`、パラペット上端=`軒高 + parapetHeightMm`。寸法線を既存スタイルで表記。
- ラベル例: `フラット（立上り h=150mm）`。

### 4.2 切妻（gable）
- 入力: `ridgeAxis`（NS/EW）、`pitchSun`（>0）、`gableEdges`（複数可、全辺指定可）。
- 平面: eaves 反映外形。棟線は `ridgeAxis` と平行な最大内接線を初期値とし、ドラッグで微調整可。
- 妻面: `gableEdges` 指定辺は妻面（垂直端）。未指定辺は軒面として棟へ向かい上がる。
- 全辺切妻: 棟なし（孤立頂点）扱い。エラーにはしない。
- 立面: 軒高=`elevationMm + heightMm`、棟高は `pitchSun` から算出。寸法線は既存スタイル。
- ラベル例: `切妻 4.0寸（棟=NS）`。

### 4.3 寄棟（hip）
- 入力: 既定 `mode=byApex`、`apexHeightMm`（>=0）。最高点は初期=重心、ポリゴン内でドラッグ移動可。
- 平面: eaves 反映外形。全辺から最高点へ放射状に上がる（辺ごと実効勾配は距離依存）。
- 立面: 軒高=`elevationMm + heightMm`、最高点=`軒高 + apexHeightMm`。寸法線は既存スタイル。
- ラベル例: `寄棟 最高点=3200mm（参考勾配: 3.5寸）`（代表値のみ併記、詳細はサイドバー）。

### 4.4 片流れ（mono）
- 入力: `pitchSun`（>0）、`monoDownhill`（N/S/E/W）。
- 平面: eaves 反映外形。単一傾斜平面。凹形状では内部に谷線が生じうる（点線・細線で表示）。
- 立面: 低側軒高=`elevationMm + heightMm`。高側端部は勾配×投影距離で算出。
- ラベル例: `片流れ 3.0寸（流れ:E、最高点H=3450mm）`。

## 5. eaves（軒の出）反映
- 基本: 屋根外形は `footprint` を外側にオフセット（eaves）した形状。凹部は Union で一体化。
- 階単位設定を既定として採用。屋根単位で `eavesOverride` により上書き可（ON/OFF/出幅/辺別）。
- 立面の軒位置・寸法線は eaves 反映後の外形基準（壁芯ではなく軒先）。

## 6. バリデーション/エラー
- `pitchSun = 0` はフラットのみ許容。他タイプで指定時はフラット提案（警告）。
- 自動下屋抽出が不可能/微小片の発生時は警告を出し、手動領域指定に誘導。
- オフセット後の極小片は面積しきい値で除去。自己交差は Union で解消し外周のみ採用。

## 7. 受け入れ基準（Done）
- 平面外形が eaves 反映かつ自己交差解消済みで安定している。
- 線画（色/点線/スケール/Z順）が既存の平面/立面と完全整合。
- ラベル/寸法線の衝突回避が機能し可読性が保たれる。
- 各タイプ別の期待挙動（切妻の全辺切妻=棟なし、寄棟 byApex、片流れの谷線表示など）が満たされる。

## 8. 将来拡張メモ
- 棟/谷の線種差（例: 外形=点線、棟=一点鎖線、谷=破線）。
- 屋根厚/仕上げレイヤの追加、パラペットの幅・開口処理。
- 勾配の度数入力・換算 UI（X寸⇄θ°）の双方向同期。

> 注: 本メモは要件の合意内容を反映した設計仕様であり、コード実装は本フェーズでは行わない。

## 9. 実装順（詳細タスク分解）
順序: フラット → 切妻 → 寄棟 → 片流れ（共通基盤は同時整備）

### 9.0 共通基盤
- [x] オフセット/Union 幾何ユーティリティ（外側オフセット 初期実装済／Union・極小片除去は今後）
- [x] 上階の陰除外ロジック（立面: 1Dスパン差分／平面: 下屋抽出に利用）
- [ ] 屋根ラベル配置/ドラッグ、衝突回避への統合
- [ ] 線画スタイル（階色＋点線）と Z 順の統一（平面/立面）
- [x] 保存スキーマ `floors[].roofUnits[]` の読み書き

### 9.1 フラット（flat）
- [x] `footprint` → eaves 外側オフセット → 外形生成
- [ ] パラペット高さ入力 UI（mm、既定150、刻み10）とバリデーション
- [ ] 平面描画（外形のみ、点線/階色）、ラベル「立上り h=…」
- [ ] 立面寸法線（軒高/パラペット上端）
- [ ] 下屋：露出領域の自動抽出（陰除外ON時）

### 9.2 切妻（gable）
- [ ] `ridgeAxis`（NS/EW）選択 UI、`pitchSun` 入力（>0）
- [ ] `gableEdges` 複数選択（全辺可、重複無視）、妻面扱い
- [ ] 棟線の初期化（軸平行の最大内接線）とドラッグ微調整
- [ ] 立面寸法線（軒高/棟高）と平面ラベル
- [ ] 全辺切妻=棟なし（孤立頂点）扱いの描画安定化

### 9.3 寄棟（hip）
- [ ] `mode=byApex` UI、`apexHeightMm` 入力（>=0）
- [ ] 最高点の初期位置（重心）と多角形内ドラッグ拘束
- [ ] 放射状勾配の計算（辺距離に応じた実効勾配）、参考勾配の代表値算出
- [ ] 立面寸法線（軒高/最高点）と平面ラベル
- [ ] 下屋への継承（byApex 既定、上書き可）

### 9.4 片流れ（mono）
- [ ] `monoDownhill`（N/S/E/W）選択 UI、`pitchSun` 入力（>0）
- [ ] 単一傾斜平面の高さ場計算と高側端部の最高点算出
- [ ] 凹形状における谷線の抽出と描画（点線/細線）
- [ ] 立面寸法線（低側軒高/高側最高点）と平面ラベル（最高点H併記）

## 10. テスト項目（洗い出し）

### 10.1 幾何/共通
- [ ] 外側オフセットの正当性（矩形/凸多角形/凹形 L・U・T）
- [ ] 自己交差の Union 解消（凹部での一体化）
- [ ] 反時計回りの維持、極小片の除去しきい値動作
- [ ] eaves per-edge の反映と既定値の適用/上書き
- [ ] 上階の陰除外 ON/OFF の切替と平面表示の整合
- [ ] 線種/色/スケール/Z順が既存平面/立面と一致
- [ ] 保存→読み込みのラウンドトリップで屋根状態が再現

### 10.2 フラット
- [ ] 立上り高さの入力/バリデーション（0以上、既定150、刻み10）
- [ ] 立面の軒高/パラペット上端が一致
- [ ] ラベル内容と位置調整の保持

### 10.3 切妻
- [ ] `ridgeAxis` に応じた棟線の初期化と編集
- [ ] `gableEdges`（0本/1本/複数/全辺）のケース別挙動
- [ ] 勾配0寸指定時にフラット提案の警告が出る
- [ ] 立面の軒高/棟高が平面設定と整合

### 10.4 寄棟
- [ ] byApex：`apexHeightMm` の反映、最高点の多角形内拘束
- [ ] 参考勾配の代表値算出（最大/平均のいずれか定義に沿う）
- [ ] 凹形状での面分割の安定性（表示破綻なし）
- [ ] 立面の軒高/最高点の寸法線整合

### 10.5 片流れ
- [ ] `monoDownhill` に沿った高さ勾配、最高点の算出
- [ ] 凹形状での谷線抽出と表示（点線/細線）
- [ ] ラベル「最高点H=…mm」併記の正確性
- [ ] 立面の低側/高側高さが平面設定と一致

### 10.6 多層/下屋
- [x] 同一平面位置での複数階屋根の重ね描き（表示順/半透明）
- [ ] 下屋の露出領域自動抽出（非採用）
- [ ] ヒットテスト：アクティブ階のみ編集可能、他階ロック

## 11. 下屋の自動抽出（非採用）
- 本フェーズでは下屋の自動抽出は導入しない。必要時は手動のフットプリント指定（将来UI）を検討。
