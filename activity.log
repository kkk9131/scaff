2025-09-11 初期化: Git リポジトリを作成し、AGENTS（英/日）と .gitignore を追加。GitHub リモート接続・main ブランチを push。
2025-09-11 追記: 言語方針/コメント/チェックリスト/二言語ドキュメント/ログ運用を AGENTS に追加。activity.log 運用開始。
2025-09-11 ドキュメント: 開発フロー（英/日）を追加し、README からリンク。
2025-09-11 ガイド: AGENTS に開発フロー順守を追記（英/日）。
2025-09-11 設定: CODEOWNERS を追加し、コードレビュー自動依頼を有効化。
2025-09-11 開発: フェーズ1スケルトン（Next.js+TS+Tailwind、UI骨格/Canvas仮）を追加。README更新。
2025-09-11 チェックリスト: フェーズ1の達成項目（Next.js環境/サイドバー/キャンバス/上部バー）を docs/開発ロードマップ.md でチェック。
2025-09-11 設定: shadcn/ui 用ボイラープレート追加（tailwindcss-animate、utils、Button、components.json）。
2025-09-11 完了: Tailwind + shadcn/ui 導入をチェックし、.gitignore に .next/ を追加。
2025-09-11 開発: Three.js + postprocessing の最小プレースホルダーを追加（3Dビュー切替対応）。
2025-09-11 ドキュメント: 開発フローをブランチ運用版に更新（英/日）。
2025-09-11 実装: フェーズ2 最小実装（内部モデルmm/座標系/スケール）を追加し、初期長方形（8000mm×6000mm）をCanvasに描画。リサイズ対応。
2025-09-11 ドキュメント: docs/2D-内部モデル_座標・単位・スケール.md を追加。ロードマップの「テンプレート呼び出し（長方形）」にチェック。
2025-09-11 実装: テンプレート追加（L字／コの字／T字）。内部モデルで多角形生成（mm）＋Canvas描画に対応。サイドバーからテンプレート切替を追加。
2025-09-11 チェックリスト: ロードマップの「テンプレート呼び出し（L字／コの字／T字）」にチェック。
2025-09-11 ドキュメント: ロードマップの競合マーカーを解消し、テンプレート（L/U/T）完了チェックを確定。
2025-09-12 15:15: フェーズ2開始用ブランチ 'phase-2' を作成
2025-09-12 15:21: 平面図の矩形で辺クリック→mm入力の寸法編集を実装（CanvasArea）。
2025-09-12 15:25: 寸法入力プロンプトを方位（北/東/南/西）表記へ変更。Canvasラベルも東西/南北表記に統一。
2025-09-12 15:33: L/U/T テンプレートの辺クリック→方位に基づく寸法入力を実装（外形寸法＋切欠/開口/バー・柱）。
2025-09-12 15:40: 非矩形の辺名称を『辺n方位』に統一。プロンプトに反映（L/U/T/T）。
2025-09-12 15:45: T字の南向き短辺（辺3/辺7）に編集を割当。入力=短辺東西長→バー幅再計算。
2025-09-12 15:49: ロードマップ更新: フェーズ2『寸法入力』を完了に変更（矩形/L/U/T, 辺番号+方位）。
2025-09-12 main 更新: origin/main を fast-forward で取り込み。
2025-09-12 ブランチ作成: フェーズ2『頂点ドラッグ編集（寸法自動更新）』着手用に 'feat/phase2-vertex-drag' を作成。
2025-09-12 ブランチ公開: 'feat/phase2-vertex-drag' を origin に push（追跡設定）。
2025-09-12 実装開始: キャンバスで頂点ハンドル表示と矩形の頂点ドラッグ→寸法自動更新（中心固定）を追加。transform に screenToModel を追加。
2025-09-12 実装: L/U/T の頂点ドラッグに対応（各頂点に応じて外形寸法・開口/切欠・バー/柱寸法を再計算）。
2025-09-12 修正: テンプレート切替が即時反映されるよう描画の再呼び出しを追加（サイドバーの開閉不要）。
2025-09-12 ロードマップ更新: フェーズ2『頂点ドラッグ編集（寸法自動更新）』を完了に変更。
2025-09-12 ブランチ作成: フェーズ2『スナップ機能（直角・グリッド吸着）』対応で 'feat/phase2-snap-orthogonal-grid' を作成。
2025-09-12 仕様追加: スナップ機能の仕様（日本語/英語）を docs/ に追加（直角±7.5°、グリッド50mm、直角→グリッド適用順）。
2025-09-12 実装: src/core/snap.ts に純粋関数群（snapToGrid/snapToOrtho/applySnaps）を追加。
2025-09-12 統合: Canvas のドラッグ処理にスナップ適用。グリッドの薄い可視化を追加。README（英/日）を更新。
2025-09-12 UI: サイドバーにスナップ設定（グリッドON/OFF・間隔、直角ON/OFF・許容角）を追加。ショートカット（g/o）を実装。
2025-09-12 UI: サイドバー各セクションの開閉アイコンを lucide-react の Chevron に変更（絵文字から置換）。デフォルトは閉。
2025-09-12 ロードマップ更新: フェーズ2『スナップ機能（直角・グリッド吸着）』を完了に変更。
2025-09-12 main 更新: origin/main を fast-forward で取り込み（スナップ機能・UI設定を反映）。

2025-09-12: フェーズ2着手、ブランチ作成、スキャフォールド追加
- 新規ブランチ `feat/phase2-dimensions-always-visible` を作成
- 設計ドキュメント `docs/design/dimensions-always-visible.md` を追加
- コア骨組み `src/core/dimensions/` （モデル/エンジン）を追加
- テスト雛形 `tests/core/dimensions/dimension_engine.spec.ts` を追加
- リポジトリ概要 `README.ja.md` を追加

2025-09-12: デモ追加・JSエンジン用意
- ブラウザ用JS版エンジン `src/core/dimensions/dimension-engine.js` を追加
- ビルド不要のSVGデモ `assets/demo-dimensions/index.html` を追加
- READMEにデモの使い方を追記

2025-09-12: UI統合モジュール追加
- SVGレンダラ `src/ui/svg/dimension-renderer.js` を追加
- UI統合デモ `assets/demo-dimensions/index-ui.html` を追加
- READMEにUI統合デモの説明を追記

2025-09-12: 直開き対応インライン版デモ追加
- `assets/demo-dimensions/index-ui-inline.html` を追加（ESM不要、file直開きでも動作）
- READMEにローカルHTTPサーバ手順とインライン版の案内を追記

2025-09-13 00:25: activity.log の運用ルールを AGENTS に追記
- `AGENTS.md` と `AGENTS.ja.md` に activity.log の統一書式（append-only/JST/箇条書き/秘密情報禁止）を追加
- 以後は追記のみ。既存行の削除・書換・並べ替えを禁止

2025-09-13 00:40: 外側判定の厳密化を実装（CW/CCW自動）
- コア: `computeForPolygon(points)` を追加し、shoelace 面積で CCW/CW を判定
- ルール: CCW→右法線が外側、CW→左法線が外側（画面座標前提）
- UI: `outsideMode`（auto/left/right）を追加し、デモにラジオボタンで切替を追加
- ドキュメント: 設計/README を更新

2025-09-13 00:55: インライン版デモの描画を堅牢化
- CSSが効かない環境でも線が見えるよう、SVG要素に `stroke`/`stroke-width`/`fill` を直接指定

2025-09-13 01:05: ラベル衝突回避を追加
- UI: `src/ui/svg/dimension-renderer.js` に簡易衝突回避を実装（BBox交差検出→外側法線方向へ段階オフセット）
- README/設計ドキュメントを更新

2025-09-13 01:25: CanvasArea に寸法オーバーレイを統合
- `src/components/CanvasArea.tsx` に SVG オーバーレイを追加（絶対配置）
- コア `DimensionEngine` を用いて多角形のCW/CCWから外側を自動判定し、寸法線＋ラベルを描画

2025-09-13 01:35: エディタの寸法表示を mm に変更
- CanvasArea の寸法ラベルを内部モデルの長さ（mm）で表示（整数mm）

2025-09-13 01:50: サイドバーに寸法設定を追加・CanvasArea対応
- Sidebar に寸法パネル（表示ON/OFF、外側モード、自動/左/右、オフセット、小数桁）を追加
- Page から CanvasArea へ設定をpropで連携
- CanvasArea 側で outsideMode/offset/decimals と表示ON/OFFを反映

2025-09-13 02:00: 寸法設定の反映不具合を修正
- CanvasArea で寸法設定を useRef に保持し、変更時に再描画
- これにより表示ON/OFF・外側モード・オフセット・小数桁が即時反映

2025-09-13 02:15: オフセットのmm指定とズーム連動、ラベル衝突回避をエディタに導入
- Sidebar: オフセット単位（px/mm）とラベル回避ON/OFFを追加
- CanvasArea: px/mm変換（pxPerMm連動）を適用、ラベル衝突回避ロジックを移植

2025-09-13 02:25: ロードマップ更新（寸法線の項目を完了）
- docs/開発ロードマップ.md のフェーズ2「寸法線＋数値の常時表示（各辺外側）」を完了に変更
- 外側判定（自動/手動）、mm表示、小数桁、オフセットpx/mm、衝突回避、リーダー線を記載

2025-09-13: フェーズ2「線スタイル（壁＝ネオンブルー、補助＝ライトグレー）」作業ブランチを作成
- ブランチ feat/phase2-line-styles を作成（ベース: main）
 - 線スタイル実装開始（壁=ネオンブルー、補助=ライトグレー）
 - 共通カラー定義を追加（src/ui/colors.ts）
 - Canvas/SVGの色指定を置換（src/components/CanvasArea.tsx）
 - デモCSSを更新（assets/demo-dimensions/index-ui.html）

2025-09-13: ロードマップ更新とコミット／プッシュ
- docs/開発ロードマップ.md のフェーズ2「線スタイル」を完了に変更
- 実装分を feat コミット、ロードマップを docs コミットで分割
- ブランチをリモートへプッシュ（feat/phase2-line-styles）

2025-09-13: mainに取り込み（PRマージ反映）
- リモートmainを取得しローカルmainへfast-forward
- ローカルはmainに切替済み（feat/phase2-line-styles は保持）

2025-09-13: 軒の出（Eaves Overhang）タスクを追加・ブランチ作成
- 設計メモを追加（docs/design/eaves-overhang.md）
- ロードマップにタスクを追記（docs/開発ロードマップ.md）
- 作業ブランチ作成（feat/phase2-eaves-overhang）

2025-09-13: 軒の出の保存時期をフェーズ5へ変更
- 設計メモを更新（本フェーズは保存対象外に明記）
- ロードマップを更新（フェーズ5に保存・読込の対象として追加）

2025-09-13 19:20: フェーズ2「軒の出」作図機能を実装・統合
- 外側オフセットユーティリティを追加（src/core/eaves/offset.ts、マイター/ベベル対応）
- キャンバスに軒の出（点線・壁色）を描画、ラベルを表示（mm）
- サイドバーに「軒の出」セクション（ON/OFF・出幅mm）を追加
- ページ状態とCanvasを接続、クリックで一括出幅更新の簡易編集対応
- ロードマップを更新（該当チェックを完了に変更）

2025-09-13 19:28: 軒の出が内側になる問題を修正
- CW時の外側法線の選択を誤って右法線にしていたのを左法線に修正
- `src/core/eaves/offset.ts` の outwardNormal 判定を更新

2025-09-13 19:35: 凹角の結合をマイターに変更
- 凸角と同様に凹角もオフセット直線の交点で結ぶ仕様へ変更
- 凹角のマイター長は既定無制限（concaveMiterLimit=∞）、平行や過剰時のみベベル
- 設計メモを更新（docs/design/eaves-overhang.md）

2025-09-13 19:42: 寸法線を軒ラインより外に配置
- 寸法線オフセットに「軒の出(mm)のpx換算＋余白(12px)」を加算
- `src/components/CanvasArea.tsx` の寸法線オフセット計算を更新

2025-09-13 19:55: 軒の出の辺ごと個別設定を実装
- データモデルに perEdge を追加しクリックで編集可能に（Canvas→Pageに反映）
- 変動距離オフセット `offsetPolygonOuterVariable` を追加（src/core/eaves/offset.ts）
- ラベルを辺ごとの値表示に変更、寸法線は最大出幅に追従

2025-09-13 20:05: ビルドエラー修正（動的importのawait除去）
- CanvasArea の描画関数で `await import` を使用していたためNext.jsビルドが失敗
- 静的 import（`offsetPolygonOuterVariable`）に置換して解消

2025-09-13 20:15: 軒ラインでの編集と描画条件の改善
- ヒットテストを拡張し、軒の出ラインを優先してクリック編集できるように変更
- per-edge=0 の辺は軒ライン/ラベルを描画しない（デフォルト0で個別のみ表示が可能）

2025-09-13 20:20: 軒の出編集ダイアログのメッセージ改善
- 「この辺」→「辺N」の表記に変更（ユーザーの意図と一致）

2025-09-13 20:28: 軒の出編集挙動（案A）を実装
- 0=この辺は無し（個別0を保存）、空欄=個別設定解除（デフォルトに戻す）
- 非数値入力は無視（変更なし）

2025-09-13 20:40: 0mm隣接時の接続をL字に修正
- 片側の隣接辺が0mmかつ凸の頂点で、軒ライン端から水平/垂直に壁頂点へL字接続
- 既存の端点置換（壁頂点直結）は撤回し、オフセット線分＋L字補助線で表現

2025-09-13 20:50: フェーズ2にズーム機能と階層管理を追加（ロードマップ更新）
- ズーム: ホイール/ピンチ/キーボード、カーソル中心、px/mm連動、UI(±/100%)
- 階層管理: 壁/寸法/軒の出/グリッド/ガイド、表示ON/OFF・ロック、サイドバーに追加予定

2025-09-13 21:00: 設計ドキュメントを追加（EN/JA）
- ズーム: docs/design/zoom.md, docs/design/zoom.ja.md
- レイヤー: docs/design/layers.md, docs/design/layers.ja.md

2025-09-13 21:05: フロア管理の要件定義を追加
- 日本語: docs/design/floors.ja.md
- 英語: docs/design/floors.md
2025-09-13 21:15: mainを最新へfast-forward
- リモートmainの変更を取り込み（git fetch → checkout main → pull --ff-only）
2025-09-14: ログ日付形式の運用変更
 - 今後は日付のみ（YYYY-MM-DD）で記録（時刻は省略）

2025-09-14: フェーズ2「ズーム機能（キャンバス拡大縮小）」の作業ブランチを作成
- ブランチを作成: feat/phase2-zoom-canvas
- リモート未プッシュ（必要なら push 要）

2025-09-15: ロードマップのズーム機能を完了に更新
- docs/開発ロードマップ.md の該当チェックを [x] に変更
- 関連ブランチ: feat/phase2-zoom-canvas

2025-09-15: ズーム機能を main に統合
- main を最新化（fetch→pull --ff-only）
- feat/phase2-zoom-canvas を main へマージし push

2025-09-15: フェーズ2「階層管理（レイヤー）」の作業ブランチを作成
- ブランチを作成: feat/phase2-layers
- リモート未プッシュ（必要なら push 要）

2025-09-15: レイヤー機能の最小実装（表示/ロック/描画順）
- 状態: Pageに layers を追加（grid/guides/walls/eaves/dims）
- UI: Sidebarに「レイヤー」セクション（表示/ロックのトグル）を追加
- Canvas: レイヤー可視で描画を分岐、ロックでヒットテスト/ドラッグを無効化

2025-09-15: 階層（フロア）UIの初期実装を追加
- Sidebarのレイヤー内に「階層」セクションを追加（選択/追加/削除/複製/高さmm）
- Pageに floors 状態とハンドラを追加（既定 1F, 2800mm）

2025-09-15: フロアの既定を「1F」と「屋根」の2つに変更
- 初期 floors に {id:'roof', name:'屋根'} を追加

2025-09-15: 複製ボタンで次の階を自動作成し壁/軒の出を複製
- Canvasからのスナップショットを受け取り、Pageで floors へ保存
- 複製時はアクティブ階を最新状態に反映後、次番号のF階を追加

2025-09-15: Canvasに階層を反映（アクティブ編集/他階半透明表示/ヒットテスト無効）
- CanvasArea: floors/activeFloorId を受け取り、非アクティブ階の壁・軒を半透明描画
- アクティブ階のみ寸法表示と編集対象に限定

2025-09-15: 非アクティブ階の視認性を改善（色分け＋半透明）
- フロアごとに配色パレットを割当て、半透明(0.55)で描画
- 軒の出も同色の点線で表示
2025-09-15: フェーズ2 ズーム機能の初期実装
- ブランチをリモート公開（feat/phase2-zoom-canvas）
- Canvasのホイール/キーボードズームを実装（カーソル中心、Ctrl+ホイール対応）
- パン（px）を内部管理し、ヒットテスト・ドラッグ・寸法描画に反映
- 右上にズームUI（- / 100% / +）を追加、ズーム倍率を表示
2025-09-15: ロードマップにE2E(Playwright MCP)を追記
- フェーズ2「ズーム機能」にE2E方針/項目を追加（Playwright＋MCP）
- test-id付与・playwright.config.ts・npmスクリプトの準備タスクを明記
2025-09-15: ロードマップにE2E（Playwright MCP）計画を追記
- フェーズ2「ズーム機能」にE2E項目を追加（Playwright＋MCP）
- セットアップ、test-id、テスト項目、実行スクリプト、MCP連携を明記
- 次アクション: test-id付与とサンプルE2E（zoom.spec.ts）作成
2025-09-15: 階層管理（floors.md）を精読し確認事項を整理
- docs/design/floors.md と floors.ja.md の要件を確認
- レイヤー設計との整合やUI挙動の不明点を質問として作成
2025-09-15: floors設計に3D準備を追記（押し出し＋軒の出）
- wallsを外周+穴（外周CCW/穴CW）で明確化
- 押し出し規則（elevationMm→elevationMm+heightMm）を定義
- 3Dでの軒の出薄板生成（既定厚50mm）を記載
2025-09-15: フェーズ2 階層管理の最小実装を開始
- 型追加（src/core/floors.ts）と自動色（src/ui/palette.ts）
- Sidebarに「階層」セクションを追加（追加/複製/削除、Z/階高、可視/ロック、選択/改名）
- Pageにfloors状態とアクティブ階、CanvasAreaに複数階描画とアクティブ階編集の受け口を追加
2025-09-15: バグ修正と複製動線の改善
- 軒の出描画で配列長不一致により例外発生→辺ごとのオフセット計算に改修
- 複製は「直上階」を自動生成（Zは下階Z+階高、色は次色、アクティブ切替）
- 階高入力UIを改善（単位表記・step/tooltip追加）
2025-09-15: 非アクティブ階の視認性を改善
- 下階を半透明塗り＋破線アウトラインで描画し、アクティブ階を前面実線に変更
2025-09-15: 非アクティブ階の半透明を一時無効化
- 要望に合わせ塗りと透過を廃止し、不透明の破線のみで表示
2025-09-15: アクティブ階切替ボタンを追加
- Sidebarの階層セクションに「▲/▼」ボタンで前後の階へ切替
2025-09-15: 非アクティブ階の描画仕様を再調整
- 線種は実線で共通、非アクティブは色を薄く（alpha≈0.55）して表示
- フロアの「👁」で可視/非表示切替（Canvas側でも尊重）
- 追加時の形状をディープコピー化（同時編集防止）。アクティブ化を自動実行
- ロック状態をCanvasで尊重（ハンドル非表示・編集無効、LOCKED表示）。ロックボタンを🔒/🔓で明示
2025-09-15: 同時編集見え問題の対策強化
- Drag中の矩形編集で即時に階層shapeへ反映（emit）するよう修正
2025-09-15: 非アクティブ階がアクティブ形状を参照する問題を修正
- 描画ループで非アクティブ階は常に自身の shape を使用（フォールバック排除）
2025-09-15: 形状更新の対象階を明示
- emit時にアクティブIDを添えて親に通知し、対象階のみ更新するよう修正
2025-09-15: 非アクティブ階が見えない件の対処
- 非アクティブ階は線は薄色実線のまま、内側をごく薄く塗って重なり時でも視認可能に
2025-09-15: 非アクティブ階の軒の出ラインを点線表示
- 各階のeaves設定を用い、非アクティブでも点線で表示（編集不可）
2025-09-15 19:45: 階層管理の仕上げとコミット準備
- 非アクティブ描画を薄色実線＋極薄塗りに調整（視認性）
- 追加/複製でshapeをディープコピーし独立編集を保証
- アクティブ切替（クリック/▲▼/PgUp・PgDn）、ロック尊重（編集無効/表示）
- 非表示(👁)をCanvasでも尊重、軒の出描画エラー修正
2025-09-15: 各階の軒の出を個別編集可能に
- 階リストに軒の出ON/OFFと一括出幅(mm)の入力を追加（キャンバスの辺クリックはアクティブ階で引き続き可能）
2025-09-15: 仕様に合わせUIと複製方針を修正
- 階リストの軒の出コントロールを撤去（編集はアクティブ階キャンバスのみ）
- 複製時は eaves を複製しない（デフォルト無効）
2025-09-15: 軒の出編集の対象階をID指定で更新
- Canvas→Page の onUpdateEaves を (id, patch) に変更し、他階への反映を防止
2025-09-15 20:10: 軒の出編集の独立性を確保して最終調整
- Canvas→PageのonUpdateEavesを(id, patch)化し、対象階のみ更新
- 非アクティブの軒の出を点線、壁は薄色+極薄塗りで視認性確保
- 階リストの軒UIを撤去、複製時のeavesはデフォルトOFF
2025-09-15 20:20: 開発ロードマップを更新（階層管理の進捗反映）
- フェーズ2に「階層（フロア）管理」完了項目を追記、3D準備/表示仕様/複製方針を明記
- フェーズ5にフロア保存（floorsスキーマ）を追加
2025-09-15 20:25: Roadmap(英語)を追加しREADMEリンク更新
- docs/Roadmap.md を追加（開発ロードマップの英訳/同期用）
- READMEに JA/EN 両方のロードマップへのリンクを追記
2025-09-15: フェーズ5「データ管理（MVP必須）」ブランチ作成
- 作業用ブランチを作成（phase5/data-management-mvp）
- フェーズ5着手準備としてロードマップを再確認
2025-09-15: フェーズ5（データ管理）実装
- JSON保存/読み込みを実装（src/io/persist.ts、TopBar配線、Page読み込みUI）
- floors/eaves/color/shapeを保存し、walls.outerはCCWへ正規化
- ローカルストレージ自動保存/復元を追加
- docs/開発ロードマップ.mdのフェーズ5を完了に更新、READMEに使い方を追記
2025-09-15: ビルドエラー修正
- src/app/page.tsx の重複インポート（createFloor）を解消
2025-09-15: サイドバーに「エディタ初期化」ボタンを追加
- Sidebarにデータセクションを追加し初期化操作を実装
- Pageから初期化処理を配線（LS消去→初期1F生成→アクティブ設定）
2025-09-15: 初期化の配置をTopBarメニューへ移動
- Sidebarのデータセクションを撤去し、TopBarに…メニューを追加
- メニュー内に「エディタを初期化」を配置
2025-09-15: 初期化の完全対応
- 初期化時にSidebar開閉/ビュー/テンプレ/寸法/スナップも既定値へ戻す
- CanvasAreaを再マウントしてズーム/パン等の内部状態もリセット
2025-09-15 15:16: ロードマップとログを更新（初期化明記）
- フェーズ5に「エディタ初期化（TopBarの…メニュー）」を追記（JA/EN）
- 完全初期化対応の記録を追加
2025-09-15 15:23: mainを最新化
- origin/main の最新コミットを取り込み（fast-forward）
